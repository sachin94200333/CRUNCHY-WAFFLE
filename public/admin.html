<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crunchy Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #09090b; color: white; font-family: 'Inter', sans-serif; }
        .admin-card { background: #18181b; border: 1px solid #27272a; border-radius: 1.5rem; padding: 1.5rem; transition: 0.3s; }
        .admin-card:hover { border-color: #ef4444; }
        .glass-input { background: #000; border: 1px solid #27272a; border-radius: 0.75rem; color: white; outline: none; transition: 0.3s; width: 100%; padding: 12px; }
        .glass-input:focus { border-color: #ef4444; }
        #admin-content { display: none; }
        #lock-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="max-w-md w-full p-8">
            <img src="/images/logo.png" class="w-32 mx-auto mb-6 animate-pulse">
            <h1 class="text-2xl font-black italic text-red-600 uppercase mb-6 tracking-tighter">Admin Authorization</h1>
            <input type="password" id="entryPass" placeholder="Enter Admin Password" class="glass-input text-center text-lg mb-4 font-bold tracking-widest">
            <button onclick="checkAuth()" class="w-full bg-red-600 py-4 rounded-xl font-black uppercase italic tracking-widest hover:bg-white hover:text-red-600 transition">Unlock Dashboard</button>
            <p id="lock-msg" class="text-red-500 text-[10px] mt-4 uppercase font-bold hidden">Access Denied!</p>
        </div>
    </div>

    <div id="admin-content" class="max-w-6xl mx-auto p-4 md:p-8 space-y-8">
        
        <div class="flex justify-between items-center">
            <h1 class="text-4xl font-black text-red-600 uppercase italic tracking-tighter">Command Center</h1>
            <button onclick="location.href='/'" class="bg-zinc-900 border border-zinc-800 px-6 py-2 rounded-full text-[10px] font-bold uppercase">Back to Site</button>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="admin-card">
                <h2 class="text-lg font-black text-red-600 uppercase italic mb-4 italic">üì¢ Offer of the Day</h2>
                <div class="flex gap-2">
                    <input type="text" id="offerText" placeholder="Aaj ka special offer..." class="glass-input">
                    <button onclick="updateOffer()" class="bg-red-600 px-6 py-3 rounded-xl font-black uppercase text-[10px]">Update</button>
                </div>
            </div>

            <div class="admin-card">
                <h2 class="text-lg font-black text-green-500 uppercase italic mb-4 italic">üì≤ GPay QR URL</h2>
                <div class="flex gap-2">
                    <input type="text" id="qrUrlInput" placeholder="Paste Image Link..." class="glass-input">
                    <button onclick="updateQR()" class="bg-green-600 px-6 py-3 rounded-xl font-black uppercase text-[10px]">Save</button>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="admin-card border-l-4 border-green-600">
                <h2 class="text-lg font-black text-green-600 uppercase italic mb-4">üí∞ Recharge Wallet</h2>
                <div class="space-y-3">
                    <input type="text" id="walletPhone" placeholder="User Mobile Number" class="glass-input">
                    <input type="number" id="walletAmount" placeholder="Amount (‚Çπ)" class="glass-input">
                    <button onclick="updateWallet()" class="w-full bg-green-600 py-3 rounded-xl font-black uppercase text-[10px]">Recharge Now</button>
                </div>
            </div>
            <div class="admin-card border-l-4 border-blue-600">
                <h2 class="text-lg font-black text-blue-600 uppercase italic mb-4">üéüÔ∏è Create Voucher</h2>
                <div class="space-y-3">
                    <input type="text" id="vCode" placeholder="Code (e.g. CRUNCHY20)" class="glass-input">
                    <input type="number" id="vDiscount" placeholder="Discount (‚Çπ)" class="glass-input">
                    <button onclick="createVoucher()" class="w-full bg-blue-600 py-3 rounded-xl font-black uppercase text-[10px]">Generate</button>
                </div>
            </div>
        </div>

        <div class="admin-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-red-600 uppercase italic">üì¶ Pending Orders</h2>
                <button onclick="loadOrders()" class="text-[10px] bg-zinc-800 px-4 py-2 rounded-full font-bold uppercase">Refresh Orders</button>
            </div>
            <div id="orderList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[400px] overflow-y-auto"></div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <div class="admin-card">
                <h2 class="text-xl font-black text-blue-500 uppercase italic mb-6">Add New Waffle</h2>
                <div class="space-y-4">
                    <input type="text" id="wName" placeholder="Name" class="glass-input">
                    <input type="number" id="wPrice" placeholder="Price" class="glass-input">
                    <input type="text" id="wImg" placeholder="Image URL" class="glass-input">
                    <button onclick="addWaffle()" class="w-full bg-blue-600 py-3 rounded-xl font-black uppercase text-[10px]">Add to Menu</button>
                </div>
                <div class="mt-8 pt-6 border-t border-zinc-800">
                    <button onclick="loadWafflesForDelete()" class="w-full border border-zinc-800 py-2 rounded-lg text-[10px] font-bold uppercase mb-4">Load Menu to Delete</button>
                    <div id="deleteList" class="space-y-2"></div>
                </div>
            </div>

            <div class="admin-card">
                <h2 class="text-xl font-black text-red-600 uppercase italic mb-6">üì© Customer Inbox</h2>
                <div id="messageList" class="space-y-4 max-h-[500px] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div class="admin-card">
            <h2 class="text-xl font-black italic text-red-600 mb-6 uppercase">Live Logo Designer</h2>
            <div class="grid md:grid-cols-2 gap-10">
                <div class="space-y-8">
                    <div>
                        <label class="block text-[10px] uppercase text-zinc-400 mb-4 font-bold">Logo Size (Width)</label>
                        <input type="range" id="wSlider" min="50" max="600" value="200" class="w-full accent-red-600">
                        <p id="wVal" class="text-right text-red-600 font-bold mt-2 text-xs">200px</p>
                    </div>
                    <button onclick="saveLayout()" class="w-full bg-red-600 py-4 rounded-xl font-black uppercase text-xs">Save Final Layout</button>
                </div>
                <div class="relative h-64 bg-black rounded-3xl border-2 border-dashed border-zinc-800 flex items-center justify-center overflow-hidden" id="adminBoundary">
                    <img id="previewLogo" src="/images/logo.png" class="absolute cursor-move" style="width: 200px;">
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <div class="admin-card">
                <h2 class="text-xl font-black text-zinc-400 uppercase italic mb-6 italic">üë• User Database</h2>
                <button onclick="loadUsers()" class="w-full border border-zinc-800 py-2 rounded-lg text-[10px] font-bold uppercase mb-4">Show All Users</button>
                <div id="userList" class="grid grid-cols-1 gap-2"></div>
            </div>

            <div class="admin-card">
                <h2 class="text-xl font-black text-yellow-500 uppercase italic mb-6 italic">üè¢ Business Info</h2>
                <div class="space-y-4">
                    <input type="text" id="phone" placeholder="Contact Phone" class="glass-input">
                    <input type="text" id="gmail" placeholder="Official Email" class="glass-input">
                    <textarea id="journey" placeholder="Journey Text..." class="glass-input h-20"></textarea>
                    <button onclick="updateAbout()" class="w-full bg-yellow-600 py-3 rounded-xl font-black uppercase text-[10px]">Save Info</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script>
        let adminPass = "";
        let posX = 0, posY = 0, currentWidth = 200;

        function checkAuth() {
            const val = document.getElementById('entryPass').value;
            if(val === "Crunchy123") {
                adminPass = val;
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadOrders(); loadMessages();
            } else {
                document.getElementById('lock-msg').classList.remove('hidden');
                setTimeout(() => document.getElementById('lock-msg').classList.add('hidden'), 2000);
            }
        }

        async function adminFetch(url, body, method = 'POST') {
            return await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ adminPassword: adminPass, ...body })
            });
        }

        async function updateOffer() {
            const res = await adminFetch('/api/admin/update-offer', { text: document.getElementById('offerText').value });
            if(res.ok) alert("Offer Updated!");
        }

        async function updateQR() {
            const res = await adminFetch('/api/save-qr', { qrUrl: document.getElementById('qrUrlInput').value });
            if(res.ok) alert("QR URL Saved!");
        }

        async function updateWallet() {
            const res = await adminFetch('/api/admin/update-wallet', { 
                phone: document.getElementById('walletPhone').value, 
                amount: Number(document.getElementById('walletAmount').value) 
            });
            if(res.ok) alert("Wallet Updated!");
        }

        async function createVoucher() {
            const res = await adminFetch('/api/admin/create-voucher', { 
                code: document.getElementById('vCode').value, 
                discount: Number(document.getElementById('vDiscount').value) 
            });
            if(res.ok) alert("Voucher Created!");
        }

        async function loadOrders() {
            const res = await adminFetch('/api/admin/all-orders', {});
            const orders = await res.json();
            document.getElementById('orderList').innerHTML = orders.map(o => `
                <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                    <div class="flex justify-between text-[8px] font-bold mb-2">
                        <span class="text-red-600 uppercase italic">${o.status}</span>
                        <span class="text-zinc-600">${new Date(o.date).toLocaleDateString()}</span>
                    </div>
                    <h3 class="font-black text-xs uppercase">${o.username}</h3>
                    <p class="text-[9px] text-zinc-500 mt-1 italic">${o.items.map(i => i.name).join(', ')}</p>
                    <div class="mt-4 flex justify-between items-end border-t border-zinc-800 pt-2">
                        <div class="text-[9px]">
                            <p class="text-green-500 font-bold italic">Cash: ‚Çπ${o.cashPaid}</p>
                            <p class="text-zinc-600">Wallet: ‚Çπ${o.walletDeducted}</p>
                        </div>
                        ${o.status === 'Pending' ? `<button onclick="approveOrder('${o._id}')" class="bg-green-600 px-3 py-1 rounded text-[8px] font-black uppercase italic">Approve</button>` : '‚úÖ'}
                    </div>
                </div>`).join('');
        }

        async function approveOrder(id) {
            const res = await adminFetch('/api/admin/approve-order', { orderId: id });
            if(res.ok) loadOrders();
        }

        async function loadMessages() {
            const res = await adminFetch('/api/admin/get-messages', {});
            const msgs = await res.json();
            document.getElementById('messageList').innerHTML = msgs.map(m => `
                <div class="bg-black p-4 rounded-xl border border-zinc-900">
                    <p class="text-[9px] text-red-600 font-bold mb-1 uppercase">${m.username}</p>
                    <p class="text-xs text-zinc-300">"${m.message}"</p>
                    <div class="mt-3 flex gap-2">
                        <input type="text" id="reply-${m._id}" placeholder="Reply..." class="flex-grow bg-zinc-900 p-2 rounded text-[10px] border-none">
                        <button onclick="replyToMsg('${m._id}')" class="bg-blue-600 px-3 rounded text-[8px] font-bold">REPLY</button>
                    </div>
                    ${m.reply ? `<p class="mt-2 text-[8px] text-green-500 italic font-bold">Sent: ${m.reply}</p>` : ''}
                </div>`).join('');
        }

        async function replyToMsg(id) {
            const res = await adminFetch('/api/admin/reply-message', { msgId: id, reply: document.getElementById(`reply-${id}`).value });
            if(res.ok) { alert("Reply Sent!"); loadMessages(); }
        }

        async function addWaffle() {
            const res = await adminFetch('/api/waffles', { 
                name: document.getElementById('wName').value, 
                price: document.getElementById('wPrice').value, 
                image: document.getElementById('wImg').value 
            });
            if(res.ok) { alert("Added!"); location.reload(); }
        }

        async function loadWafflesForDelete() {
            const res = await fetch('/api/waffles');
            const waffles = await res.json();
            document.getElementById('deleteList').innerHTML = waffles.map(w => `
                <div class="flex justify-between items-center p-2 bg-zinc-900 rounded-lg text-[9px] uppercase">
                    <span>${w.name} (‚Çπ${w.price})</span>
                    <button onclick="deleteWaffle('${w._id}')" class="text-red-500 font-bold">DELETE</button>
                </div>`).join('');
        }

        async function deleteWaffle(id) {
            const res = await adminFetch('/api/waffles/' + id, {}, 'DELETE');
            if(res.ok) loadWafflesForDelete();
        }

        async function loadUsers() {
            const res = await adminFetch('/api/admin/get-users', {});
            const users = await res.json();
            document.getElementById('userList').innerHTML = users.map(u => `
                <div class="bg-zinc-900 p-3 rounded-xl flex justify-between items-center text-[10px]">
                    <div><p class="font-black text-red-600">${u.username}</p><p class="text-zinc-600">${u.phone}</p></div>
                    <div class="text-right"><p class="text-green-500 font-bold">‚Çπ${u.walletBalance}</p><p class="text-yellow-500 font-bold">${u.loyaltyPoints} Pts</p></div>
                </div>`).join('');
        }

        async function updateAbout() {
            const res = await adminFetch('/api/about', { 
                phone: document.getElementById('phone').value, 
                gmail: document.getElementById('gmail').value,
                journey: document.getElementById('journey').value
            });
            if(res.ok) alert("Info Updated!");
        }

        // LOGO DESIGNER LOGIC
        const wSlider = document.getElementById('wSlider');
        wSlider.oninput = function() {
            currentWidth = this.value;
            document.getElementById('wVal').innerText = currentWidth + "px";
            document.getElementById('previewLogo').style.width = currentWidth + "px";
        };

        interact('#previewLogo').draggable({
            listeners: { move(event) { posX += event.dx; posY += event.dy; event.target.style.transform = `translate(${posX}px, ${posY}px)`; } },
            modifiers: [ interact.modifiers.restrictRect({ restriction: '#adminBoundary', endOnly: true }) ]
        });

        async function saveLayout() {
            const res = await adminFetch('/api/save-logo', { width: currentWidth + "px", x: posX + "px", y: posY + "px" });
            if(res.ok) alert("Logo Layout Saved!");
        }
    </script>
</body>
</html>